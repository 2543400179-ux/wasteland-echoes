const e=[{id:'fatal_temperature_low',label:'致命低温',check:e=>'number'==typeof e.体温&&e.体温<32},{id:'fatal_temperature_high',label:'致命高温',check:e=>'number'==typeof e.体温&&e.体温>41},{id:'fatal_exhaustion',label:'体力衰竭',check:e=>e.体力<=1&&e.创伤&&(e.创伤.includes('重伤')||e.创伤.includes('严重'))},{id:'fatal_infection',label:'严重感染',check:e=>e.创伤&&(e.创伤.includes('严重感染')||e.创伤.includes('败血症'))},{id:'fatal_injury',label:'致命外伤',check:e=>e.创伤&&(e.创伤.includes('大出血')||e.创伤.includes('致命伤'))}];function n(e,n){return`[系统：结局条件已触发 — ${e}]\n\n当前状态：体温${n.体温}℃ / 体力${n.体力} / 创伤：${n.创伤} / 抗体：${n.抗体}\n\n这是 Bad Ending，游戏结束，不应给玩家转机或继续发展。\n请根据当前状态和剧情自由创作结局，内容和标题完全由你决定。\n禁止输出 [option:]，结局楼层不允许有任何选项。\n在结尾用以下格式输出（界面会解析并显示解锁动画）：\n[收集:结局:你创作的标题｜一句话描述]`}let t=null,c=!1;function i(n){for(const t of e)try{if(t.check(n))return t}catch{}return null}async function a(){await waitGlobalInitialized('Mvu'),console.info('[条件分歧] 系统初始化'),eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,e=>{const a=_.get(e,'stat_data');if(a)for(const o of Object.keys(a)){const l=a[o];if(!l||'object'!=typeof l)continue;if(l._已触发结局||c)continue;const r=i(l);if(r){console.info(`[条件分歧] 触发: ${r.label}`),c=!0,_.set(e,`stat_data.${o}._已触发结局`,!0),t&&t.uninject(),t=injectPrompts([{id:'ending_trigger',position:'in_chat',depth:1,role:'system',content:n(r.label,l)}]),toastr.error(`${r.label} — Bad Ending`,'⚠️ 结局触发',{timeOut:8e3,closeButton:!0});break}}}),eventOn(tavern_events.MESSAGE_RECEIVED,async()=>{if(!c)return;const e=getChatMessages(-1);if(!e||0===e.length)return;const n=function(e){const n=e.match(/\[收集:结局[：:]([^\]]+)\]/);if(!n)return null;const t=n[1].trim(),c=t.search(/[｜|]/);return{标题:c>=0?t.slice(0,c).trim():t,描述:c>=0?t.slice(c+1).trim():''}}(e[0].message||'');n&&(await async function(e){try{const n=getVariables({type:'character'}),t=n.收集||{},c=t.结局||[];c.some(n=>n.标题===e.标题)||c.push(e),await replaceVariables({...n,收集:{...t,结局:c}},{type:'character'}),console.info(`[条件分歧] 结局已收集: ${e.标题}`)}catch(e){console.error('[条件分歧] 保存结局收集失败:',e)}}(n),t&&(t.uninject(),t=null))}),console.info('[条件分歧] 事件监听已设置')}$(()=>{errorCatched(a)()}),$(window).on('pagehide',()=>{t&&(t.uninject(),t=null),console.info('[条件分歧] 脚本卸载')});
//# sourceMappingURL=index.js.map