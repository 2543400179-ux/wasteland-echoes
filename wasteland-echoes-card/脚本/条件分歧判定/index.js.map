{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/wasteland-echoes-card/脚本/条件分歧判定/index.ts"],"sourcesContent":["/**\n * 条件分歧判定脚本\n *\n * 检测MVU变量中的极端危险状态：\n * 1. 标记 _已触发结局 = true（AI不再继续故事）\n * 2. 注入提示词引导AI自由创作BE，用 [收集:结局:标题｜描述] 格式输出\n * 3. 脚本解析 [收集:] 指令后存入角色卡变量 收集.结局\n */\n\n// ============ 危险条件 ============\n\ninterface DangerCondition {\n  id: string;\n  label: string;\n  check: (u: any) => boolean;\n}\n\nconst DANGER_CONDITIONS: DangerCondition[] = [\n  {\n    id: 'fatal_temperature_low',\n    label: '致命低温',\n    check: u => typeof u.体温 === 'number' && u.体温 < 32,\n  },\n  {\n    id: 'fatal_temperature_high',\n    label: '致命高温',\n    check: u => typeof u.体温 === 'number' && u.体温 > 41,\n  },\n  {\n    id: 'fatal_exhaustion',\n    label: '体力衰竭',\n    check: u =>\n      typeof u.体力 === 'number' &&\n      u.体力 > 0 &&\n      u.体力 <= 1 &&\n      u.创伤 &&\n      (u.创伤.includes('重伤') || u.创伤.includes('严重')),\n  },\n  {\n    id: 'fatal_infection',\n    label: '严重感染',\n    check: u => u.创伤 && (u.创伤.includes('严重感染') || u.创伤.includes('败血症')),\n  },\n  {\n    id: 'fatal_injury',\n    label: '致命外伤',\n    check: u => u.创伤 && (u.创伤.includes('大出血') || u.创伤.includes('致命伤')),\n  },\n];\n\n// ============ 提示词构建 ============\n\nfunction buildEndingPrompt(label: string, userData: any): string {\n  return `[系统：结局条件已触发 — ${label}]\n\n当前状态：体温${userData.体温}℃ / 体力${userData.体力} / 创伤：${userData.创伤} / 抗体：${userData.抗体}\n\n这是 Bad Ending，游戏结束，不应给玩家转机或继续发展。\n请根据当前状态和剧情自由创作结局，内容和标题完全由你决定。\n禁止输出 [option:]，结局楼层不允许有任何选项。\n在结尾用以下格式输出（界面会解析并显示解锁动画）：\n[收集:结局:你创作的标题｜一句话描述]`;\n}\n\n// ============ 结局收集（角色卡变量） ============\n\ninterface CollectionItem {\n  标题: string;\n  描述: string;\n}\n\nfunction parseCollectionTag(text: string): CollectionItem | null {\n  // 匹配 [收集:结局:标题｜描述] 或 [收集:结局:标题|描述] 或 [收集:结局:标题]\n  const match = text.match(/\\[收集:结局[：:]([^\\]]+)\\]/);\n  if (!match) return null;\n  const rest = match[1].trim();\n  const sepIdx = rest.search(/[｜|]/);\n  const title = sepIdx >= 0 ? rest.slice(0, sepIdx).trim() : rest;\n  const desc = sepIdx >= 0 ? rest.slice(sepIdx + 1).trim() : '';\n  return { 标题: title, 描述: desc };\n}\n\nasync function saveEndingToCollection(item: CollectionItem): Promise<void> {\n  try {\n    const charVars = getVariables({ type: 'character' }) as Record<string, any>;\n    const collection = charVars.收集 || {};\n    const endings: CollectionItem[] = collection.结局 || [];\n\n    if (!endings.some(e => e.标题 === item.标题)) {\n      endings.push(item);\n    }\n\n    await replaceVariables({ ...charVars, 收集: { ...collection, 结局: endings } }, { type: 'character' });\n    console.info(`[条件分歧] 结局已收集: ${item.标题}`);\n  } catch (e) {\n    console.error('[条件分歧] 保存结局收集失败:', e);\n  }\n}\n\n// ============ 核心逻辑 ============\n\nlet endingInjection: { uninject: () => void } | null = null;\nlet endingTriggered = false;\n\nfunction checkDangerConditions(userData: any): DangerCondition | null {\n  for (const cond of DANGER_CONDITIONS) {\n    try {\n      if (cond.check(userData)) return cond;\n    } catch {\n      // skip\n    }\n  }\n  return null;\n}\n\nasync function init(): Promise<void> {\n  await waitGlobalInitialized('Mvu');\n  console.info('[条件分歧] 系统初始化');\n\n  // 监听MVU变量更新\n  eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, variables => {\n    const statData = _.get(variables, 'stat_data');\n    if (!statData) return;\n\n    for (const key of Object.keys(statData)) {\n      const userData = statData[key];\n      if (!userData || typeof userData !== 'object') continue;\n\n      if (userData._已触发结局 || endingTriggered) continue;\n\n      const triggered = checkDangerConditions(userData);\n      if (!triggered) continue;\n\n      console.info(`[条件分歧] 触发: ${triggered.label}`);\n      endingTriggered = true;\n\n      _.set(variables, `stat_data.${key}._已触发结局`, true);\n\n      if (endingInjection) endingInjection.uninject();\n      endingInjection = injectPrompts([\n        {\n          id: 'ending_trigger',\n          position: 'in_chat',\n          depth: 1,\n          role: 'system',\n          content: buildEndingPrompt(triggered.label, userData),\n        },\n      ]);\n\n      toastr.error(`${triggered.label} — Bad Ending`, '⚠️ 结局触发', { timeOut: 8000, closeButton: true });\n      break;\n    }\n  });\n\n  // 监听消息完成，解析 [收集:结局:] 并存入角色卡变量\n  eventOn(tavern_events.MESSAGE_RECEIVED, async () => {\n    if (!endingTriggered) return;\n\n    const messages = getChatMessages(-1);\n    if (!messages || messages.length === 0) return;\n\n    const lastMsg = messages[0];\n    const content = lastMsg.message || '';\n    const item = parseCollectionTag(content);\n\n    if (item) {\n      await saveEndingToCollection(item);\n\n      if (endingInjection) {\n        endingInjection.uninject();\n        endingInjection = null;\n      }\n    }\n  });\n\n  console.info('[条件分歧] 事件监听已设置');\n}\n\n// ============ 启动与清理 ============\n\n$(() => {\n  errorCatched(init)();\n});\n\n$(window).on('pagehide', () => {\n  if (endingInjection) {\n    endingInjection.uninject();\n    endingInjection = null;\n  }\n  console.info('[条件分歧] 脚本卸载');\n});\n"],"names":["DANGER_CONDITIONS","id","label","check","u","includes","buildEndingPrompt","userData","endingInjection","endingTriggered","checkDangerConditions","cond","async","init","waitGlobalInitialized","console","info","eventOn","Mvu","events","VARIABLE_UPDATE_ENDED","variables","statData","_","get","key","Object","keys","triggered","set","uninject","injectPrompts","position","depth","role","content","toastr","error","timeOut","closeButton","tavern_events","MESSAGE_RECEIVED","messages","getChatMessages","length","item","text","match","rest","trim","sepIdx","search","slice","parseCollectionTag","message","charVars","getVariables","type","collection","endings","some","e","push","replaceVariables","saveEndingToCollection","$","errorCatched","window","on"],"sourceRoot":""}