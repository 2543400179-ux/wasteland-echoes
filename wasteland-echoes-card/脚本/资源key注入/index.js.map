{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/wasteland-echoes-card/脚本/资源key注入/index.ts"],"sourcesContent":["/**\n * 资源 key 注入脚本\n */\n\nconst RESOURCE_ENTRY_NAME = '[res]资源库';\nconst INJECT_ID = 'wasteland-echoes-resource-keys';\n\n/** 顶级分类标题 */\nconst SECTION_HEADERS = ['角色立绘', '背景图', 'CG', 'BGM'] as const;\n\n/** 将 YAML 内容按顶级分类拆分为 { 分类名: 内容 } */\nfunction splitSections(yamlContent: string): Record<string, string> {\n  const result: Record<string, string> = {};\n  const headerPattern = new RegExp(`^(${SECTION_HEADERS.join('|')}):\\\\s*$`, 'm');\n  let remaining = yamlContent;\n\n  while (true) {\n    const match = remaining.match(headerPattern);\n    if (!match) break;\n\n    const headerName = match[1];\n    const startIdx = match.index! + match[0].length;\n    remaining = remaining.substring(startIdx);\n\n    // 找下一个顶级分类的起始位置\n    const nextMatch = remaining.match(headerPattern);\n    const sectionContent = nextMatch ? remaining.substring(0, nextMatch.index!) : remaining;\n    result[headerName] = sectionContent;\n\n    if (!nextMatch) break;\n    remaining = remaining.substring(nextMatch.index!);\n  }\n\n  return result;\n}\n\n/** 从 YAML 内容提取 key 列表 */\nfunction buildKeysSummary(yamlContent: string): string | null {\n  try {\n    if (!yamlContent || typeof yamlContent !== 'string') {\n      console.warn('[资源key注入] YAML内容为空');\n      return null;\n    }\n\n    const lines = ['[可用资源key]（以下为唯一合法枚举，不得编造、不得自行补充；未列出时只能使用\"暂无\"）'];\n    const sections = splitSections(yamlContent);\n\n    // 提取角色立绘 — 二级为角色名，三级为表情名\n    if (sections['角色立绘']) {\n      const charBlocks = sections['角色立绘'].split(/\\n(?=[ \\t]{2}\\S)/);\n      const chars: string[] = [];\n      for (const block of charBlocks) {\n        const nameMatch = block.match(/^\\s{2}(\\S[^:]*?):\\s*$/m);\n        if (nameMatch) {\n          const faces = [...block.matchAll(/\\n\\s{4}(\\S[^:]*?):\\s/g)].map(m => m[1].trim());\n          if (faces.length) {\n            chars.push(nameMatch[1].trim() + '(' + faces.join(',') + ')');\n          }\n        }\n      }\n      if (chars.length) lines.push('角色立绘: ' + chars.join(', '));\n    }\n\n    // 提取背景图 / BGM / CG — 二级为 key 名\n    for (const section of ['背景图', 'BGM', 'CG'] as const) {\n      if (sections[section]) {\n        const keys = [...sections[section].matchAll(/\\n\\s{2}(\\S[^:]*?):\\s/g)].map(m => m[1].trim());\n        if (keys.length) lines.push(section + ': ' + keys.join(', '));\n      }\n    }\n\n    console.info('[资源key注入] 解析完成，共' + lines.length + '行');\n    return lines.length > 1 ? lines.join('\\n') : null;\n  } catch (e) {\n    console.error('[资源key注入] 解析失败:', e);\n    return null;\n  }\n}\n\n/** 查找资源条目 */\nasync function findResourceContent() {\n  const charWorldbooks = getCharWorldbookNames('current');\n  const worldbookNames = [];\n\n  if (charWorldbooks.primary) worldbookNames.push(charWorldbooks.primary);\n  worldbookNames.push(...charWorldbooks.additional);\n  worldbookNames.push(...getGlobalWorldbookNames());\n\n  const uniqueNames = [...new Set(worldbookNames)];\n\n  for (const wbName of uniqueNames) {\n    try {\n      const entries = await getWorldbook(wbName);\n      const entry = entries.find(e => e.name === RESOURCE_ENTRY_NAME || e.name.includes('[res]'));\n      if (entry && entry.content) {\n        console.info('[资源key注入] 找到资源条目：' + entry.name + ' in ' + wbName);\n        return entry.content;\n      }\n    } catch (err) {\n      console.warn('[资源key注入] 读取世界书失败：' + wbName, err);\n    }\n  }\n  return null;\n}\n\nasync function init() {\n  console.info('[资源key注入] 脚本开始执行...');\n\n  const content = await findResourceContent();\n  if (!content) {\n    console.warn('[资源key注入] 未找到资源条目');\n    return;\n  }\n\n  const summary = buildKeysSummary(content);\n  if (!summary) {\n    console.warn('[资源key注入] 解析失败');\n    return;\n  }\n\n  let currentResult: ReturnType<typeof injectPrompts> | null = null;\n\n  // 注入函数\n  function doInject() {\n    // 先清理旧的注入\n    if (currentResult?.uninject) {\n      currentResult.uninject();\n    }\n\n    currentResult = injectPrompts([\n      {\n        id: INJECT_ID,\n        position: 'in_chat',\n        depth: 0,\n        role: 'system',\n        should_scan: true,\n        content: summary!,\n      },\n      {\n        id: INJECT_ID + '-debug',\n        position: 'in_chat',\n        depth: 0,\n        role: 'assistant',\n        content: '【DEBUG-RESOURCE-KEYS】\\n' + summary!,\n      },\n    ]);\n\n    console.info('[资源key注入] ✅ 注入成功，长度：' + summary!.length);\n  }\n\n  // 初始注入\n  doInject();\n\n  // 监听生成开始事件，每次生成前重新注入\n  const unsubscribe = eventOn(tavern_events.GENERATION_STARTED, () => {\n    console.info('[资源key注入] 检测到生成开始，重新注入');\n    doInject();\n  });\n\n  // 卸载时清理\n  $(window).on('pagehide', () => {\n    if (currentResult?.uninject) currentResult.uninject();\n    unsubscribe.stop();\n  });\n}\n\n$(() => {\n  errorCatched(init)();\n});\n"],"names":["INJECT_ID","SECTION_HEADERS","buildKeysSummary","yamlContent","console","warn","lines","sections","result","headerPattern","RegExp","join","remaining","match","headerName","startIdx","index","length","substring","nextMatch","sectionContent","splitSections","charBlocks","split","chars","block","nameMatch","faces","matchAll","map","m","trim","push","section","keys","info","e","error","async","init","content","charWorldbooks","getCharWorldbookNames","worldbookNames","primary","additional","getGlobalWorldbookNames","uniqueNames","Set","wbName","entry","getWorldbook","find","name","includes","err","findResourceContent","summary","currentResult","doInject","uninject","injectPrompts","id","position","depth","role","should_scan","unsubscribe","eventOn","tavern_events","GENERATION_STARTED","$","window","on","stop","errorCatched"],"sourceRoot":""}