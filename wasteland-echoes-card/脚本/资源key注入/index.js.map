{"version":3,"file":"index.js","mappings":"AAAA,MAAM,EAA+BA,KCyFrCC,eAAeC,IACb,MAAMC,QA1BRF,iBACE,MAAMG,EAAiBC,sBAAsB,WACvCC,EAA2B,GAE7BF,EAAeG,SAASD,EAAeE,KAAKJ,EAAeG,SAC/DD,EAAeE,QAAQJ,EAAeK,YACtCH,EAAeE,QAAQE,2BAEvB,MAAMC,EAAc,IAAI,IAAIC,IAAIN,IAEhC,IAAK,MAAMO,KAAUF,EACnB,IACE,MACMG,SADgBC,aAAaF,IACbG,KAAKC,GA3DL,aA2DUA,EAAEC,MAAgCD,EAAEC,KAAKC,SAAS,UAClF,GAAIL,GAAOX,QAET,OADAiB,QAAQC,KAAK,qBAAqBP,EAAMI,kBAAkBJ,EAAMQ,gBAAgBT,MACzEC,EAAMX,OAEjB,CAAE,MACA,QACF,CAEF,OAAO,IACT,CAGwBoB,GACtB,IAAKpB,EAEH,YADAiB,QAAQI,KAAK,0BAIf,MAAMC,EAnER,SAA0BC,GACxB,IACE,MAAMC,EAAM,QAAWD,GACvB,IAAKC,EAAK,OAAO,KAEjB,MAAMC,EAAkB,CAAC,aAEzB,GAAID,EAAI,KAAM,CACZ,MAAME,EAAQC,OAAOC,QAAQJ,EAAI,MAAMK,IAAI,EAAEd,EAAMe,KAAW,GAAGf,KAAQY,OAAOI,KAAKD,GAAOE,KAAK,SAC7FN,EAAMO,QAAQR,EAAMpB,KAAK,SAASqB,EAAMM,KAAK,QACnD,CAEA,GAAIR,EAAI,IAAK,CACX,MAAMO,EAAOJ,OAAOI,KAAKP,EAAI,KACzBO,EAAKE,QAAQR,EAAMpB,KAAK,QAAQ0B,EAAKC,KAAK,QAChD,CAEA,GAAIR,EAAIU,IAAK,CACX,MAAMH,EAAOJ,OAAOI,KAAKP,EAAIU,KACzBH,EAAKE,QAAQR,EAAMpB,KAAK,QAAQ0B,EAAKC,KAAK,QAChD,CAEA,GAAIR,EAAIW,GAAI,CACV,MAAMJ,EAAOJ,OAAOI,KAAKP,EAAIW,IACzBJ,EAAKE,QAAQR,EAAMpB,KAAK,OAAO0B,EAAKC,KAAK,QAC/C,CAEA,OAAOP,EAAMQ,OAAS,EAAIR,EAAMO,KAAK,MAAQ,IAC/C,CAAE,MAAOlB,GAEP,OADAG,QAAQmB,MAAM,uBAAwBtB,GAC/B,IACT,CACF,CAmCkBuB,CAAiBrC,GACjC,IAAKsB,EAEH,YADAL,QAAQI,KAAK,8BAIf,MAAM,SAAEiB,GAAaC,cAAc,CACjC,CACEC,GArFY,iCAsFZC,SAAU,UACVC,MAAO,EACPC,KAAM,SACN3C,QAASsB,KAIbL,QAAQC,KAAK,2BAA2BI,EAAQW,iBAEhDW,EAAEC,QAAQC,GAAG,WAAY,KACvBR,KAEJ,CAEAM,EAAE,KACAG,aAAahD,EAAbgD","sources":["src://tavern_helper_template/external var \"YAML\"","src://tavern_helper_template/src/wasteland-echoes-card/脚本/资源key注入/index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = YAML;","/**\n * 资源 key 注入脚本\n *\n * 核心思路：资源条目（[res]资源库）在世界书中设为【关闭】状态，\n * 这样完整的 URL 不会作为提示词发给 AI 浪费 token。\n *\n * 本脚本在加载时：\n * 1. 通过 getWorldbook 读取关闭态的资源条目（API 能读到所有条目，无论开关）\n * 2. 解析 YAML，提取所有资源 key 名称（不含 URL）\n * 3. 用 injectPrompts 将紧凑的 key 列表注入给 AI\n *\n * 这样 AI 能看到可用的资源 key（如背景图名、角色表情名），\n * 而前端界面通过同样的 getWorldbook 读取完整 URL 来加载资源。\n * 两边各取所需，token 消耗降到最低。\n */\n\nimport * as YAML from 'yaml';\n\nconst RESOURCE_ENTRY_NAME = '[res]资源库';\nconst INJECT_ID = 'wasteland-echoes-resource-keys';\n\ninterface RawResourceYaml {\n  角色立绘?: Record<string, Record<string, string>>;\n  背景图?: Record<string, string>;\n  BGM?: Record<string, string>;\n  CG?: Record<string, string>;\n}\n\n/** 从 YAML 内容提取 key 列表，生成紧凑文本 */\nfunction buildKeysSummary(yamlContent: string): string | null {\n  try {\n    const raw = YAML.parse(yamlContent) as RawResourceYaml;\n    if (!raw) return null;\n\n    const lines: string[] = ['[可用资源key]'];\n\n    if (raw.角色立绘) {\n      const parts = Object.entries(raw.角色立绘).map(([name, faces]) => `${name}(${Object.keys(faces).join(',')})`);\n      if (parts.length) lines.push(`角色立绘: ${parts.join(', ')}`);\n    }\n\n    if (raw.背景图) {\n      const keys = Object.keys(raw.背景图);\n      if (keys.length) lines.push(`背景图: ${keys.join(', ')}`);\n    }\n\n    if (raw.BGM) {\n      const keys = Object.keys(raw.BGM);\n      if (keys.length) lines.push(`BGM: ${keys.join(', ')}`);\n    }\n\n    if (raw.CG) {\n      const keys = Object.keys(raw.CG);\n      if (keys.length) lines.push(`CG: ${keys.join(', ')}`);\n    }\n\n    return lines.length > 1 ? lines.join('\\n') : null;\n  } catch (e) {\n    console.error('[资源key注入] YAML 解析失败:', e);\n    return null;\n  }\n}\n\n/** 从世界书中查找资源条目内容 */\nasync function findResourceContent(): Promise<string | null> {\n  const charWorldbooks = getCharWorldbookNames('current');\n  const worldbookNames: string[] = [];\n\n  if (charWorldbooks.primary) worldbookNames.push(charWorldbooks.primary);\n  worldbookNames.push(...charWorldbooks.additional);\n  worldbookNames.push(...getGlobalWorldbookNames());\n\n  const uniqueNames = [...new Set(worldbookNames)];\n\n  for (const wbName of uniqueNames) {\n    try {\n      const entries = await getWorldbook(wbName);\n      const entry = entries.find(e => e.name === RESOURCE_ENTRY_NAME || e.name.includes('[res]'));\n      if (entry?.content) {\n        console.info(`[资源key注入] 找到资源条目 \"${entry.name}\" (enabled=${entry.enabled}) in \"${wbName}\"`);\n        return entry.content;\n      }\n    } catch {\n      continue;\n    }\n  }\n  return null;\n}\n\nasync function init() {\n  const content = await findResourceContent();\n  if (!content) {\n    console.warn('[资源key注入] 未找到资源条目，跳过注入');\n    return;\n  }\n\n  const summary = buildKeysSummary(content);\n  if (!summary) {\n    console.warn('[资源key注入] 资源条目为空或解析失败，跳过注入');\n    return;\n  }\n\n  const { uninject } = injectPrompts([\n    {\n      id: INJECT_ID,\n      position: 'in_chat',\n      depth: 1,\n      role: 'system',\n      content: summary,\n    },\n  ]);\n\n  console.info(`[资源key注入] 已注入资源 key 列表 (${summary.length} chars)`);\n\n  $(window).on('pagehide', () => {\n    uninject();\n  });\n}\n\n$(() => {\n  errorCatched(init)();\n});\n"],"names":["YAML","async","init","content","charWorldbooks","getCharWorldbookNames","worldbookNames","primary","push","additional","getGlobalWorldbookNames","uniqueNames","Set","wbName","entry","getWorldbook","find","e","name","includes","console","info","enabled","findResourceContent","warn","summary","yamlContent","raw","lines","parts","Object","entries","map","faces","keys","join","length","BGM","CG","error","buildKeysSummary","uninject","injectPrompts","id","position","depth","role","$","window","on","errorCatched"],"sourceRoot":""}