const n='wasteland-echoes-resource-keys',t=['角色立绘','背景图','CG','BGM'];function o(n){try{if(!n||'string'!=typeof n)return console.warn('[资源key注入] YAML内容为空'),null;const o=['[可用资源key]（以下为唯一合法枚举，不得编造、不得自行补充；未列出时只能使用"暂无"）'],e=function(n){const o={},e=new RegExp(`^(${t.join('|')}):\\s*$`,'m');let s=n;for(;;){const n=s.match(e);if(!n)break;const t=n[1],c=n.index+n[0].length;s=s.substring(c);const i=s.match(e),r=i?s.substring(0,i.index):s;if(o[t]=r,!i)break;s=s.substring(i.index)}return o}(n);if(e['角色立绘']){const n=e['角色立绘'].split(/\n(?=[ \t]{2}\S)/),t=[];for(const o of n){const n=o.match(/^\s{2}(\S[^:]*?):\s*$/m);if(n){const e=[...o.matchAll(/\n\s{4}(\S[^:]*?):\s/g)].map(n=>n[1].trim());e.length&&t.push(n[1].trim()+'('+e.join(',')+')')}}t.length&&o.push('角色立绘: '+t.join(', '))}for(const n of['背景图','BGM','CG'])if(e[n]){const t=[...e[n].matchAll(/\n\s{2}(\S[^:]*?):\s/g)].map(n=>n[1].trim());t.length&&o.push(n+': '+t.join(', '))}return console.info('[资源key注入] 解析完成，共'+o.length+'行'),o.length>1?o.join('\n'):null}catch(n){return console.error('[资源key注入] 解析失败:',n),null}}async function e(){console.info('[资源key注入] 脚本开始执行...');const t=await async function(){const n=getCharWorldbookNames('current'),t=[];n.primary&&t.push(n.primary),t.push(...n.additional),t.push(...getGlobalWorldbookNames());const o=[...new Set(t)];for(const n of o)try{const t=(await getWorldbook(n)).find(n=>'[res]资源库'===n.name||n.name.includes('[res]'));if(t&&t.content)return console.info('[资源key注入] 找到资源条目：'+t.name+' in '+n),t.content}catch(t){console.warn('[资源key注入] 读取世界书失败：'+n,t)}return null}();if(!t)return void console.warn('[资源key注入] 未找到资源条目');const e=o(t);if(!e)return void console.warn('[资源key注入] 解析失败');let s=null;function c(){s?.uninject&&s.uninject(),s=injectPrompts([{id:n,position:'in_chat',depth:0,role:'system',should_scan:!0,content:e},{id:n+'-debug',position:'in_chat',depth:0,role:'assistant',content:'【DEBUG-RESOURCE-KEYS】\n'+e}]),console.info('[资源key注入] ✅ 注入成功，长度：'+e.length)}c();const i=eventOn(tavern_events.GENERATION_STARTED,()=>{console.info('[资源key注入] 检测到生成开始，重新注入'),c()});$(window).on('pagehide',()=>{s?.uninject&&s.uninject(),i.stop()})}$(()=>{errorCatched(e)()});
//# sourceMappingURL=index.js.map